{% extends "base_elite.html" %}

{% block title %}Factures - Globibat CRM Elite{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Factures</h1>
        <p class="page-subtitle">Gestion de la facturation</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-secondary">
            <i class="ri-download-2-line"></i>
            <span>Exporter</span>
        </button>
        <button class="btn btn-primary" onclick="openFactureModal()">
            <i class="ri-add-line"></i>
            <span>Nouvelle facture</span>
        </button>
    </div>
</div>

<div class="stats-grid mb-xl">
    <div class="stat-card">
        <div class="stat-icon blue">
            <i class="ri-file-text-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ factures|length }}</div>
            <div class="stat-label">Total factures</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon green">
            <i class="ri-check-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ factures|selectattr('statut', 'equalto', 'payee')|list|length }}</div>
            <div class="stat-label">Payées</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon orange">
            <i class="ri-time-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ factures|selectattr('statut', 'equalto', 'en_attente')|list|length }}</div>
            <div class="stat-label">En attente</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon primary">
            <i class="ri-money-euro-circle-line"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ "{:,.0f}".format(factures|sum(attribute='montant_ttc')|default(0)) }} €</div>
            <div class="stat-label">CA Total</div>
        </div>
    </div>
</div>

<div class="card">
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Numéro</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>Montant HT</th>
                    <th>TVA</th>
                    <th>Total TTC</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for facture in factures %}
                <tr>
                    <td class="font-mono">{{ facture.numero }}</td>
                    <td>{{ facture.client.nom if facture.client else '-' }}</td>
                    <td>{{ facture.date_facture.strftime('%d/%m/%Y') if facture.date_facture else '-' }}</td>
                    <td>{{ "{:,.2f}".format(facture.montant_ht) }} €</td>
                    <td>{{ "{:,.2f}".format(facture.tva) }} €</td>
                    <td class="font-semibold">{{ "{:,.2f}".format(facture.montant_ttc) }} €</td>
                    <td>
                        <span class="badge badge-{{ 'success' if facture.statut == 'payee' else 'warning' if facture.statut == 'en_attente' else 'danger' }}">
                            {{ facture.statut }}
                        </span>
                    </td>
                    <td>
                        <div class="flex gap-xs">
                            <a class="btn btn-ghost" title="Télécharger PDF" href="/api/factures/{{ facture.id }}/pdf">
                                <i class="ri-download-line"></i>
                            </a>
                            <button class="btn btn-ghost" title="Envoyer par email" onclick="sendEmail({{ facture.id }})">
                                <i class="ri-mail-line"></i>
                            </button>
                            <button class="btn btn-ghost" title="Modifier" onclick="editFacture({{ facture.id }})">
                                <i class="ri-edit-line"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--grid-gap);
}

.stat-card {
    background: var(--blanc-pur);
    border-radius: 16px;
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-md);
    box-shadow: var(--shadow-base);
    transition: all var(--duration-fast) var(--ease-out-quart);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
}

.stat-icon.blue {
    background: rgba(30, 64, 175, 0.1);
    color: var(--bleu-accent);
}

.stat-icon.green {
    background: rgba(22, 163, 74, 0.1);
    color: var(--vert-validation);
}

.stat-icon.orange {
    background: rgba(249, 115, 22, 0.1);
    color: var(--orange-construction);
}

.stat-icon.primary {
    background: linear-gradient(135deg, rgba(30, 64, 175, 0.1), rgba(30, 64, 175, 0.05));
    color: var(--bleu-accent);
}

.stat-content {
    flex: 1;
}

.stat-value {
    font-size: var(--text-2xl);
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--gris-medium);
}

.font-mono {
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
}

.mb-xl {
    margin-bottom: var(--space-xl);
}
</style>

<!-- Modal Facture -->
<div id="factureModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="factureModalTitle">Nouvelle facture</h2>
      <button class="close-btn" onclick="closeFactureModal()">&times;</button>
    </div>
    <form id="factureForm" onsubmit="saveFacture(event)">
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Client *</label>
            <select name="client_id" class="form-control" required>
              <option value="">-- Sélectionner --</option>
              {% for client in clients %}
              <option value="{{ client.id }}">{{ client.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Date de facture</label>
            <input name="date_facture" type="date" class="form-control" value="">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Description *</label>
          <textarea name="description" class="form-control" rows="3" required></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Montant HT (€)</label>
            <input name="montant_ht" type="number" step="0.01" class="form-control" onchange="calculateFactureTTC()">
          </div>
          <div class="form-group">
            <label class="form-label">TVA (%)</label>
            <input name="tva_pct" type="number" step="0.01" class="form-control" value="20" onchange="calculateFactureTTC()">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Montant TTC (€)</label>
            <input name="montant_ttc" type="number" step="0.01" class="form-control" readonly>
          </div>
          <div class="form-group">
            <label class="form-label">Statut</label>
            <select name="statut" class="form-control">
              <option value="en_attente">En attente</option>
              <option value="payee">Payée</option>
              <option value="annulee">Annulée</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Date d'échéance</label>
          <input name="date_echeance" type="date" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeFactureModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<style>
.modal {position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;}
.modal-content {background: #fff; border-radius: 12px; max-width: 880px; margin: 5vh auto; overflow: hidden;}
.modal-header, .modal-footer {padding: 20px; border-bottom: 1px solid #e8eaed;}
.modal-footer {border-bottom: 0; border-top: 1px solid #e8eaed;}
.modal-body {padding: 20px; max-height: 60vh; overflow-y: auto;}
.close-btn {border: none; background: transparent; font-size: 24px; cursor: pointer;}
.form-row {display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;}
.form-group {display: flex; flex-direction: column;}
.form-label {font-size: 14px; font-weight: 600; margin-bottom: 8px;}
.form-control {padding: 10px 12px; border: 1px solid #e8eaed; border-radius: 8px; font-size: 14px;}
.form-control:focus {outline: none; border-color: #1E40AF; box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);}
@media (max-width: 768px) {.form-row {grid-template-columns: 1fr;}}
</style>

<script>
let currentFacture = null;

function openFactureModal() {
    currentFacture = null;
    document.getElementById('factureModalTitle').textContent = 'Nouvelle facture';
    document.getElementById('factureForm').reset();
    document.getElementById('factureModal').style.display = 'block';
}

function closeFactureModal() {
    document.getElementById('factureModal').style.display = 'none';
}

function editFacture(id) {
    currentFacture = id;
    document.getElementById('factureModalTitle').textContent = 'Modifier la facture';
    // TODO: Pré-remplir le formulaire avec les données existantes
    document.getElementById('factureModal').style.display = 'block';
}

function calculateFactureTTC() {
    const form = document.getElementById('factureForm');
    const ht = parseFloat(form.montant_ht.value) || 0;
    const tva_pct = parseFloat(form.tva_pct.value) || 0;
    const ttc = ht * (1 + tva_pct / 100);
    form.montant_ttc.value = ttc.toFixed(2);
}

function saveFacture(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    // Calculer le montant TVA
    data.tva = (parseFloat(data.montant_ht) * parseFloat(data.tva_pct) / 100).toFixed(2);
    delete data.tva_pct;
    
    const url = currentFacture ? `/api/factures/${currentFacture}` : '/api/factures';
    const method = currentFacture ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeFactureModal();
            location.reload();
        } else {
            alert(result.message || 'Erreur lors de l\'enregistrement');
        }
    });
}

function sendEmail(id) {
    if (confirm('Envoyer la facture par email au client ?')) {
        // TODO: Implémenter l'envoi par email
        alert('Fonctionnalité d\'envoi email à venir');
    }
}

// Fermer modal en cliquant dehors
window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});
</script>
{% endblock %}
