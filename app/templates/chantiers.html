{% extends "base_elite.html" %}

{% block title %}Chantiers - Globibat CRM Elite{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Chantiers</h1>
        <p class="page-subtitle">Suivi de vos projets en cours</p>
    </div>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openChantierModal()">
            <i class="ri-add-line"></i>
            <span>Nouveau chantier</span>
        </button>
    </div>
</div>

<div class="projects-grid">
    {% for chantier in chantiers %}
    <div class="project-card-full">
        <div class="project-header">
            <div class="project-icon large">
                <i class="ri-building-line"></i>
            </div>
            <div class="project-info">
                <h3>{{ chantier.nom }}</h3>
                <p>{{ chantier.client.nom if chantier.client else 'Client non défini' }}</p>
                <div class="project-meta">
                    <span><i class="ri-map-pin-line"></i> {{ chantier.adresse }}</span>
                    <span><i class="ri-calendar-line"></i> {{ chantier.date_debut.strftime('%d/%m/%Y') if chantier.date_debut else '-' }}</span>
                </div>
            </div>
            <div class="project-status">
                <span class="badge badge-{{ 'success' if chantier.statut == 'termine' else 'info' }}">
                    {{ chantier.statut }}
                </span>
            </div>
        </div>
        
        <div class="project-stats">
            <div class="stat-item">
                <div class="stat-label">Budget</div>
                <div class="stat-value">{{ "{:,.0f}".format(chantier.budget_initial) }} €</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Consommé</div>
                <div class="stat-value text-orange">{{ "{:,.0f}".format(chantier.budget_consomme) }} €</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Progression</div>
                <div class="stat-value">{{ "%.0f"|format((chantier.budget_consomme / chantier.budget_initial * 100) if chantier.budget_initial else 0) }}%</div>
            </div>
        </div>
        
        <div class="project-progress">
            <div class="progress-bar large">
                <div class="progress-fill" style="width: {{ (chantier.budget_consomme / chantier.budget_initial * 100) if chantier.budget_initial else 0 }}%">
                    <div class="progress-glow"></div>
                </div>
            </div>
        </div>
        
        <div class="project-actions">
            <a class="btn btn-secondary" href="/chantiers/{{ chantier.id }}">
                <i class="ri-eye-line"></i>
                Détails
            </a>
            <button class="btn btn-ghost" onclick="editChantier({{ chantier.id }})">
                <i class="ri-edit-line"></i>
                Modifier
            </button>
            <button class="btn btn-ghost" onclick="showDocuments({{ chantier.id }})">
                <i class="ri-file-list-3-line"></i>
                Documents
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<style>
.projects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: var(--grid-gap);
}

.project-card-full {
    background: var(--blanc-pur);
    border-radius: 20px;
    padding: var(--space-xl);
    box-shadow: var(--shadow-base);
    transition: all var(--duration-base) var(--ease-out-quart);
}

.project-card-full:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
}

.project-icon.large {
    width: 64px;
    height: 64px;
    font-size: 32px;
}

.project-meta {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-sm);
    font-size: var(--text-sm);
    color: var(--gris-medium);
}

.project-meta i {
    margin-right: 4px;
}

.project-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
    margin: var(--space-lg) 0;
    padding: var(--space-lg);
    background: var(--gris-froid);
    border-radius: 12px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: var(--text-sm);
    color: var(--gris-medium);
    margin-bottom: 4px;
}

.stat-value {
    font-size: var(--text-xl);
    font-weight: 700;
}

.text-orange {
    color: var(--orange-construction);
}

.progress-bar.large {
    height: 12px;
}

.project-actions {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-lg);
}
</style>

<!-- Modal Chantier -->
<div id="chantierModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="chantierModalTitle">Nouveau chantier</h2>
      <button class="close-btn" onclick="closeChantierModal()">&times;</button>
    </div>
    <form id="chantierForm" onsubmit="saveChantier(event)">
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nom du chantier *</label>
            <input name="nom" class="form-control" required>
          </div>
          <div class="form-group">
            <label class="form-label">Client</label>
            <select name="client_id" class="form-control">
              <option value="">-- Sélectionner --</option>
              {% for client in clients %}
              <option value="{{ client.id }}">{{ client.nom }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Adresse</label>
            <input name="adresse" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">Chef de chantier</label>
            <select name="chef_chantier_id" class="form-control">
              <option value="">-- Sélectionner --</option>
              {% for employe in employes %}
              <option value="{{ employe.id }}">{{ employe.prenom }} {{ employe.nom }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Date début</label>
            <input name="date_debut" type="date" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">Date fin prévue</label>
            <input name="date_fin_prevue" type="date" class="form-control">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Budget initial (€)</label>
            <input name="budget_initial" type="number" step="0.01" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label">Statut</label>
            <select name="statut" class="form-control">
              <option value="planifie">Planifié</option>
              <option value="en_cours">En cours</option>
              <option value="termine">Terminé</option>
              <option value="suspendu">Suspendu</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeChantierModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Documents -->
<div id="documentsModal" class="modal" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Documents du chantier</h2>
      <button class="close-btn" onclick="closeDocumentsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="documents-list" id="documentsList">
        <p class="text-muted">Chargement...</p>
      </div>
      <div class="mt-lg">
        <input type="file" id="docUpload" accept=".pdf,.doc,.docx,.xls,.xlsx" style="display:none">
        <button class="btn btn-primary" onclick="document.getElementById('docUpload').click()">
          <i class="ri-upload-2-line"></i> Ajouter un document
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.modal {position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;}
.modal-content {background: #fff; border-radius: 12px; max-width: 880px; margin: 5vh auto; overflow: hidden;}
.modal-header, .modal-footer {padding: 20px; border-bottom: 1px solid #e8eaed;}
.modal-footer {border-bottom: 0; border-top: 1px solid #e8eaed;}
.modal-body {padding: 20px; max-height: 60vh; overflow-y: auto;}
.close-btn {border: none; background: transparent; font-size: 24px; cursor: pointer;}
.form-row {display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;}
.form-group {display: flex; flex-direction: column;}
.form-label {font-size: 14px; font-weight: 600; margin-bottom: 8px;}
.form-control {padding: 10px 12px; border: 1px solid #e8eaed; border-radius: 8px; font-size: 14px;}
.form-control:focus {outline: none; border-color: #1E40AF; box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);}
@media (max-width: 768px) {.form-row {grid-template-columns: 1fr;}}
.documents-list {min-height: 200px;}
.document-item {display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid #e8eaed; border-radius: 8px; margin-bottom: 8px;}
.document-item:hover {background: #f7f8fa;}
</style>

<script>
let currentChantier = null;

function openChantierModal() {
    currentChantier = null;
    document.getElementById('chantierModalTitle').textContent = 'Nouveau chantier';
    document.getElementById('chantierForm').reset();
    document.getElementById('chantierModal').style.display = 'block';
}

function closeChantierModal() {
    document.getElementById('chantierModal').style.display = 'none';
}

function editChantier(id) {
    currentChantier = id;
    document.getElementById('chantierModalTitle').textContent = 'Modifier le chantier';
    // Charger les données
    fetch('/api/chantiers')
        .then(r => r.json())
        .then(list => {
            const chantier = list.find(c => c.id === id);
            if (!chantier) return;
            const form = document.getElementById('chantierForm');
            form.nom.value = chantier.nom || '';
            form.client_id.value = chantier.client_id || '';
            form.adresse.value = chantier.adresse || '';
            form.date_debut.value = chantier.date_debut ? chantier.date_debut.split('T')[0] : '';
            form.date_fin_prevue.value = chantier.date_fin_prevue ? chantier.date_fin_prevue.split('T')[0] : '';
            form.statut.value = chantier.statut || 'planifie';
            document.getElementById('chantierModal').style.display = 'block';
        });
}

function saveChantier(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData);
    
    const url = currentChantier ? `/api/chantiers/${currentChantier}` : '/api/chantiers';
    const method = currentChantier ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeChantierModal();
            location.reload();
        } else {
            alert(result.message || 'Erreur lors de l\'enregistrement');
        }
    });
}

function showDocuments(chantierId) {
    document.getElementById('documentsModal').style.display = 'block';
    const list = document.getElementById('documentsList');
    list.innerHTML = `
        <div class="document-item">
            <i class="ri-file-pdf-line" style="font-size: 24px; color: #DC2626;"></i>
            <div style="flex: 1;">
                <div style="font-weight: 600;">Plan architectural.pdf</div>
                <div style="font-size: 12px; color: #9CA3AF;">Ajouté le 15/01/2025</div>
            </div>
            <button class="btn btn-ghost"><i class="ri-download-2-line"></i></button>
        </div>
        <div class="document-item">
            <i class="ri-file-excel-line" style="font-size: 24px; color: #16A34A;"></i>
            <div style="flex: 1;">
                <div style="font-weight: 600;">Budget détaillé.xlsx</div>
                <div style="font-size: 12px; color: #9CA3AF;">Ajouté le 10/01/2025</div>
            </div>
            <button class="btn btn-ghost"><i class="ri-download-2-line"></i></button>
        </div>
    `;
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').style.display = 'none';
}

// Upload document
document.getElementById('docUpload')?.addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const formData = new FormData();
        formData.append('file', file);
        fetch('/api/upload', {
            method: 'POST',
            body: formData
        }).then(r => r.json()).then(res => {
            if (res.success) {
                alert('Document ajouté: ' + res.filename);
                showDocuments(currentChantier);
            }
        });
    }
});

// Fermer modals en cliquant dehors
window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) {
        e.target.style.display = 'none';
    }
});
</script>
{% endblock %}
